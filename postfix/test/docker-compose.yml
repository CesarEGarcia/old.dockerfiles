version: '3.7'

services:
  postfix:

    build:
      context: docker/postfix

    ports:
      - target: 25
        published: 25
        protocol: tcp
        mode: host


    volumes:
      - ./etc:/opt/postfix/conf
      - ./dominios:/home/dominios
      - ./log:/var/log/host
      - ./spool:/opt/postfix/spool
      - ./data:/opt/postfix/data

    # environment:
    #   - MULTI_INSTANCE_NAME="MX"

    environment:
      MULTI_INSTANCE_NAME:      MX
      MY_HOSTNAME:              mx.ametel.es
      MY_NETWORKS:              127.0.0.1
      SMTP_BIND_ADDRESS:        51.91.13.123
      VIRTUAL_MAILBOX_DOMAINS:  hash:/opt/postfix/conf/domains
      VIRTUAL_MAILBOX_BASE:     /home/dominios
      VIRTUAL_MAILBOX_MAPS:     hash:/opt/postfix/conf/users
      VIRTUAL_ALIAS_MAPS:       hash:/opt/postfix/conf/alias


      SMTPD_RECIPIENT_RESTRICTIONS: >
        permit_mynetworks,
        reject_unauth_destination,
        check_client_access hash:/opt/postfix/conf/check_client_access,
        check_helo_access pcre:/opt/usuarios/helo_access.pcre,
        reject_non_fqdn_helo_hostname,
        reject_invalid_helo_hostname,
        reject_non_fqdn_sender,
        reject_unknown_sender_domain,
        reject_unauth_pipelining,
        reject_non_fqdn_recipient,
        reject_unknown_recipient_domain,
        reject_unlisted_recipient,
        #       reject_unknown_client_hostname,
        check_recipient_access hash:/opt/usuarios/bloquear_destinos,
        check_sender_access hash:/opt/usuarios/nogreylist,
        #       check_client_access pcre:/opt/usuarios/filter_default,
        reject_rbl_client bl.spamcop.net,
        reject_rbl_client zen.spamhaus.org,
        reject_rhsbl_sender dbl.spamhaus.org,
        ##        check_policy_service unix:private/postgrey,
        permit

    networks:
      - localNetwork

  postmap:
    image: postfix:3.4.5
    working_dir: /opt/postfix/conf
    entrypoint: "/opt/postfix/bin/postmap"
    volumes:
      - ./etc:/opt/postfix/conf


networks:
  localNetwork:

