#!/bin/bash

/opt/postfix/bin/postconf "multi_instance_name          = ${MULTI_INSTANCE_NAME}"
/opt/postfix/bin/postconf "myhostname                   = ${MY_HOSTNAME}"
/opt/postfix/bin/postconf "mynetworks                   = ${MY_NETWORKS}"
/opt/postfix/bin/postconf "smtp_bind_address            = ${SMTP_BIND_ADDRESS}"
/opt/postfix/bin/postconf "virtual_mailbox_domains      = ${VIRTUAL_MAILBOX_DOMAINS}"
/opt/postfix/bin/postconf "virtual_mailbox_base         = ${VIRTUAL_MAILBOX_BASE}"
/opt/postfix/bin/postconf "virtual_mailbox_maps         = ${VIRTUAL_MAILBOX_MAPS}"
/opt/postfix/bin/postconf "virtual_alias_maps           = ${VIRTUAL_ALIAS_MAPS}"

# postconf no admite multilineas
echo '' >> /opt/postfix/etc/main.cf
echo '' >> /opt/postfix/etc/main.cf
echo 'smtpd_recipient_restrictions =' >> /opt/postfix/etc/main.cf
echo "     $SMTPD_RECIPIENT_RESTRICTIONS" | awk -F',' '{$1=$1}1' OFS='\n    ' >> /opt/postfix/etc/main.cf
echo '' >> /opt/postfix/etc/main.cf
echo '' >> /opt/postfix/etc/main.cf

if [ -n $SSL ]; then
    echo 'smtpd_tls_cert_file       = /etc/letsencrypt/live/'${SSL}'/fullchain.pem' >> /opt/postfix/etc/main.cf
    echo 'smtpd_tls_key_file        = /etc/letsencrypt/live/'${SSL}'/privkey.pem' >> /opt/postfix/etc/main.cf
    echo 'smtpd_tls_received_header = yes' >> /opt/postfix/etc/main.cf
    echo 'smtpd_tls_security_level  = may' >> /opt/postfix/etc/main.cf
    echo 'tls_random_source         = dev:/dev/urandom' >> /opt/postfix/etc/main.cf
    echo 'smtpd_tls_loglevel        = 1' >> /opt/postfix/etc/main.cf
    echo 'smtp_tls_security_level   = may' >> /opt/postfix/etc/main.cf
    echo 'smtp_tls_loglevel         = 1' >> /opt/postfix/etc/main.cf
    echo '' >> /opt/postfix/etc/main.cf
    echo '' >> /opt/postfix/etc/main.cf
fi


if [ "$SASL" = "yes" ]; then
    echo '' >> opt/postfix/etc/main.cf
    echo '##############' >> /opt/postfix/etc/main.cf
    echo '#${SASL} = yes' >> /opt/postfix/etc/main.cf
    echo 'smtpd_sasl_auth_enable          = yes' >> opt/postfix/etc/main.cf
    echo 'smtpd_sasl_security_options     = noanonymous' >> opt/postfix/etc/main.cf
    echo 'broken_sasl_auth_clients        = yes' >> opt/postfix/etc/main.cf
    echo 'smtpd_sasl_type                 = dovecot' >> opt/postfix/etc/main.cf
    echo 'smtpd_sasl_path                 = inet:dovecot:26' >> opt/postfix/etc/main.cf
    #Meter una cabecera con el usuario autenticdo
    echo 'smtpd_sasl_authenticated_header = yes' >> opt/postfix/etc/main.cf
    echo '' >> /opt/postfix/etc/main.cf
    echo 'smtpd_relay_restrictions =' >> /opt/postfix/etc/main.cf
    echo '  permit_mynetworks' >> /opt/postfix/etc/main.cf
    echo '  permit_sasl_authenticated' >> /opt/postfix/etc/main.cf
    echo '  reject_unauth_destination' >> /opt/postfix/etc/main.cf
    echo '  reject' >> /opt/postfix/etc/main.cf
    echo '' >> /opt/postfix/etc/main.cf
    echo '' >> /opt/postfix/etc/main.cf
fi


#mkdir /opt/postfix/data
#chown postfix.postfix /opt/postfix/data
#rm /opt/postfix/data/master.lock
chown vmail.vmail /home/dominios

exit 0

