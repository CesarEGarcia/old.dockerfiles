#!/bin/bash

cd /opt/dovecot/etc/dovecot/conf.d

# 10-auth.conf
sed 's/#disable_plaintext_auth = yes/disable_plaintext_auth = yes/' -i 10-auth.conf
sed 's/^auth_mechanisms =.*/auth_mechanisms = plain login/' -i 10-auth.conf
sed 's/!include auth-system.conf.ext/#!include auth-system.conf.ext/' -i 10-auth.conf
sed 's/#!include auth-passwdfile.conf.ext/!include auth-passwdfile.conf.ext/' -i 10-auth.conf


# 10-logging.conf
sed 's|#log_path =.*|log_path = /var/log/dovecot/dovecot.log|' -i 10-logging.conf
sed 's|#info_log_path =.*|info_log_path = /var/log/dovecot/dovecot-info.log|' -i 10-logging.conf
sed 's/#auth_verbose = no/auth_verbose = yes/' -i 10-logging.conf
sed 's/#auth_verbose_passwords = no/auth_verbose_passwords = yes/' -i 10-logging.conf

if [ "$AUTH_DEBUG" = "yes" ]; then
    sed 's/#auth_debug = no/auth_debug = yes/' -i 10-logging.conf
fi
if [ "$AUTH_DEBUG_PASSWORDS" = "yes" ]; then
    sed 's/#auth_debug_passwords = no/auth_debug_passwords= yes/' -i 10-logging.conf
fi


# 10-mail.conf
sed 's|#mail_location =|mail_location = mdbox:~/mdbox|' -i 10-mail.conf


# 10-master.conf
#sed 's/{IMAP_IP}/'${IMAP_IP}'/g' -i 10-master.conf
#sed 's/{POP3_IP}/'${POP3_IP}'/g' -i 10-master.conf


# 10-ssl.conf
if [ -n $SSL ]; then
    sed 's/#ssl = yes/ssl = yes/' -i 10-ssl.conf
    sed 's|ssl_cert =.*|ssl_cert = /etc/letsencrypt/live/'${SSL}'/fullchain.pem|' -i 10-ssl.conf
    sed 's|ssl_key =.*|ssl_key = /etc/letsencrypt/live/'${SSL}'/privkey.pem|' -i 10-ssl.conf
fi

#sed -e '/^ssl_cert =/ s/^#*/#/' -i 10-ssl.conf
#sed -e '/^ssl_key =/  s/^#*/#/' -i 10-ssl.conf


# auth-passwdfile.conf.ext
sed 's|args = scheme=CRYPT username_format=%u /etc/dovecot/users|args = scheme=CRYPT username_format=%u /opt/dovecot/conf/passwords/%d|' -i auth-passwdfile.conf.ext
sed 's|args = username_format=%u /etc/dovecot/users|args = username_format=%u /opt/dovecot/conf/passwords/%d|' -i auth-passwdfile.conf.ext


mkdir /opt/dovecot/spool/private -p
chown postfix /opt/dovecot/spool/private
exit 0
